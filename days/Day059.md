
---

# Day 059 - 思考を運ぶ声の道を「操作」で整える

## 🎯 本日のテーマ

思考を転送するBotの**音声→文字の入口**を、

* **無音で区切る**
* **音量を一定に保つ**
* **不要帯域を抑える**
* **区切りを相手に見せる**
* **入出力の契約を固定する**
  という\*\*“操作”\*\*を軸に整えていく。

## 🧠 背景・思想

声は人にとっていちばん自然なI/Oやし、**不審さを下げたまま意図を運べる**。
まずは音声→文字で**意味の骨格**をつかみ、反応を**一定**に保てる道を作る。

## ⚙️ 実装と試行（元ログを整理）

### 構成

* **A. STTサーバー（`stt_server.py`）**

  * FastAPI + Uvicorn、Whisper small をロード（GPUあればCUDA、なければCPU）
  * `POST /transcribe` に `wav` を投げると文字起こしを返す
  * 起動: `uvicorn stt_server:app --host 0.0.0.0 --port 8000`

* **B. Audio Ingest サーバー（`audio_server.py`）**

  * WebSocket で **PCM** を受信
  * `"END"` を受けたら一時WAVに保存 → STTサーバーへPOST → 結果をクライアントへ返送

* **C. クライアント**

  * **① マイク入力版（`client_ws_mic.py`）**

    * `sounddevice` 使用、**5秒ごと**に `"END"` を送ってチャンク区切り、結果を表示
  * **② ファイルループ版（`client_ws_fileloop.py`）**

    * `soundfile` + `librosa` で MP3 を読込 → **16kHz/mono PCM** へ変換
    * **5秒チャンク**でWS送信、ループ再生のように繰返し

### 発生した問題

1. **砂嵐ノイズ／爆音**
   　- サンプリングレートや PCM/float32 取り扱いの齟齬
   　- 例：サーバ側 `wf.setframerate(48000)` とクライアント側 `RATE=16000` が食い違い
2. **接続エラー**
   　- `[Errno 10048]`（ポート占有）、`ConnectionClosedError`（切断順序）
3. **認識空振り／文字化け**
   　- 渡す音声破損、チャンク短すぎ問題の疑い

### 現時点の結論（元ログの要旨）

* **自作リアルタイム**は不安定（形式・SR・バッファ調整が難しい）
* 代替案：

  1. **一旦ファイル保存→STT** へ投げる方式に切替
  2. **既存OSS**（`faster-whisper-server` / `whisper-websocket`）を活用
  3. **外部STT**（Deepgram / Speechmatics 等）も評価

## 📊 操作フェーズチェック

* **該当**：**① 入力**／**② 出力**／**④ 見られ方**（＋**⑤ トリガー**は補助）
* **除外**：**⑦（ベクトルの向き）**は今回は**非該当**

**操作 → 成功条件 → いまの打ち手（参考）**

* **無音で区切る** → 文を自然に切る／取りこぼし少 → 当面**5秒固定＋"END"**（将来：VAD＋EOS）
* **音量を一定に保つ** → 小声/大声/雑踏でも安定 → **RMS正規化**（目安 **-26 LUFS**）
* **不要帯域を抑える** → 低域ノイズの誤認抑制 → **HPF 100–150Hz**（必要に応じLPF）
* **区切りを見せる** → 確定タイミングを可視化 → まず `"END"` 明示（将来：**ビープ/UI**）
* **入出力の契約を固定** → 互換性と再現性の確保 → **16kHz/mono/PCM16** を**I/O契約**に明記

## 🔁 洞察と考察

* **混乱の原因は手法ベース**で考えてたから。**操作ベース**にすると目的がぶれへん
* 体験品質は「速さ」より**反応の一定さ**が効く
* I/O契約を**最初に書面化**すると、デバッグ効率が段違い

## 🪶 雑記・気づき

* 48k/16kの食い違いは体験を一撃で壊す。最初に契約、これ鉄則
* **5秒**は読みやすいが、意味単位のズレは出る → VAD＋終端検出で可変へ

## 🙏 感謝・引用

* Whisper / faster-whisper / FastAPI 周辺の知見に感謝
* メモ：「**操作を決めれば手段は選別される**。契約を書けば事故は減る」

## 🛠 次の挑戦メモ

* [ ] **I/O契約ドキュメント**：16kHz/mono/PCM16、正規化目安、無音閾値、許容誤差
* [ ] **フォルダ監視→STT→SRT/ASS** の**安定フロー**（まずはファイル単位で固める）
* [ ] **VAD＋EOS**で区切り可変化（文単位の自然切断へ）
* [ ] **区切り可視化**（短音ビープ／UIインジケータ）
* [ ] **OSS RTサーバ**（faster-whisper等）の試用計画
* [ ] **E2Eテスト**：静音/街頭/反響/風切り/音楽混じりの5ケース

## 📝 タイトル案

* 「思考を運ぶ声の道を、操作で整える」
* 「区切り・音量・帯域・契約」
* 「速さより、揺れない挙動」

## 🏷 タグ

\#STT #Whisper #FastAPI #WebSocket #操作設計 #見られ方 #I/O契約

---
