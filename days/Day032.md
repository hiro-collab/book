# Day032 — Twitterアーカイブ→NDJSON→RAG下拵え

## 📝 タイトル
**TwitterアーカイブをNDJSON化してRAG下拵え**

## 🎯 本日のテーマ
- **操りたいもの**：Twitterアーカイブ（`data/tweets.js`）を**NDJSON**に正規化して、RAGに食べさせるコーパス化。
- **きっかけ**：自動発信Botの基盤づくり。まずは自分のツイート群を“自分の知識ベース”として扱えるように整形したかった。
- **願い・意味**：思考の可搬化・冗長化。万一に備え、**自分の視点を機械に載せ替え**られる土台を増やしていく。

## 🧠 背景・思想
- **身体感覚・過去の経験**：自分が過去に書いた文書が思い出せない、まとめられない。なら**機械に掘り起こしてもらう**。  
- **サイバー／可視化との関わり**：過去の**記憶**の代わりに、過去の**記録**を利用。記録＝外部出力＝顕現された自身の把握内容（Belief）を、**自在に操る**。意のままに操る技術がサイバー。**見えない過去の記憶を見える形に可視化**する。  
- **制約・環境との結びつき**：思い出せなくても、これなら大丈夫。

## ⚙️ 実装と試行
- **今日の実施メモ**  
  - **使ったツール／データ**：ChatGPTの作成した Python コード、Twitter のアーカイブファイル、Python、VS Code  
  - **選定理由**：ChatGPT の勧めるまま使用。  
  - **工夫／つまずき／発見**：つまずきは特になし。**JSON だとデータベースとして扱いやすい**らしい。違いは何だろう。  
  - **結果**：**NDJSON** に変換できた。

- **スクリプト要点（既存仕様のメモ）**：
  - `full_text` を本文として採用、t.co は `entities.urls[].expanded_url` を使って **展開文字列 `text_expanded`** を付与
  - `source` の HTML タグは除去してプレーン化
  - `created_at` → `created_at_iso`（UTC ISO-8601）
  - 判定フラグ：`is_retweet` / `is_reply` / `is_quote`
  - 追跡用メタ：`_kind`（`tweet|note_tweet`）、`_source`（元ファイル名）

- **実行例（PowerShell）**：
```powershell
# 1) tweets.js を単体で NDJSON 化
python .	witter_archive_to_ndjson.py `
  --file .\data	weets.js `
  --out .	weets.ndjson

# 2) data ディレクトリをまとめて処理（ノート含む）
python .	witter_archive_to_ndjson.py `
  --data-dir .\data `
  --include-notes `
  --out .	weets+notes.ndjson
```

- **最小インジェスト例（Python）**（説明は日本語、コメントは英語）:
```python
# Minimal NDJSON ingestion example
# - Reads NDJSON and builds (text, metadata) tuples.
from pathlib import Path
import json

src = Path('tweets.ndjson')
docs = []

with src.open('r', encoding='utf-8') as f:
    for line in f:
        obj = json.loads(line)
        if obj.get('is_retweet'):
            continue  # skip retweets
        text = obj.get('text_expanded') or obj.get('text') or ''
        meta = {
            'id': obj.get('id'),
            'created_at': obj.get('created_at_iso') or obj.get('created_at'),
            'lang': obj.get('lang'),
            'source': obj.get('source'),
            'is_reply': obj.get('is_reply'),
            'is_quote': obj.get('is_quote'),
        }
        # TODO: embed and upsert to your vector DB
        docs.append((text, meta))

print(f"loaded: {len(docs)} docs")
```


## 📚 付録：NDJSONとは？（JSON / JS との違い）
**NDJSON（Newline Delimited JSON / JSON Lines, `.ndjson` / `.jsonl`）**は、**1行=1オブジェクト**で並べる形式。  
巨大データでも**ストリーム処理**・**追記**・**並列**がやりやすく、RAGの「1件=1ドキュメント」運用と相性が良い。

### ✅ NDJSONの特徴
- **ストリーム処理**：1行ずつ読める→メモリ消費が低く、途中中断や再開が簡単。  
- **追記・結合が容易**：`copy >>` や `cat file*.ndjson > all.ndjson` で連結OK。
- **行単位の堅牢性**：1行が壊れても**他の行は有効**（配列の"]"欠落で全滅…みたいな事故を避けやすい）。
- **ツール親和性**：UNIX系の`wc -l`/`head`/`split`や、バッチ分割・並列投入と相性◎。
- **版管理に強い**：差分が行単位で分かりやすい（Git 等）。

### 🆚 普通のJSON（配列JSON）との違い
- **配列JSON（例）**：
```json
[
  {"id":"1","text":"hello"},
  {"id":"2","text":"world"}
]
```
- **NDJSON（例）**：
```
{"id":"1","text":"hello"}
{"id":"2","text":"world"}
```
- 違いの要点：
  - 配列JSONは**全体が1つの値**（先頭`[`と末尾`]`が必要）→ちょっとの壊れで**全部読めなくなる**ことがある。
  - NDJSONは**1行=1オブジェクト**→**部分読み/部分再処理が容易**。巨大ファイルや長期運用に向く。
  - 逆に、**厳密にネストを保った1塊の構造**を丸ごと保持したい用途は配列JSONが向く。

### 🆚 JS（Twitterエクスポートの `.js`）との違い
- **Twitterの`tweets.js`（例）**：
```javascript
// Not pure JSON; JS assignment wrapper
window.YTD.tweets.part0 = [
  {"tweet": {"id":"1","full_text":"hello"}},
  {"tweet": {"id":"2","full_text":"world"}}
];
```
- 違いの要点：
  - これは**JavaScriptの変数代入**であって**純粋なJSONではない**（パーサでそのまま読めない）。
  - セキュリティ/移植性の観点でも、**ラッパ剥離**が必要。RAG等のETLでは**素朴なJSON/NDJSON**が望ましい。
  - NDJSONにすると、**ストリーム投入・並列化・再処理**が一気に楽になる。

### 📝 NDJSONを使うときの注意
- **1行=1つの妥当なJSON**（末尾に改行）。
- 改行は**LF推奨**（Windowsで編集する場合も、処理系を跨ぐならLFに統一すると安全）。
- **スキップ条件**（例：`is_retweet==true`）などの前処理を**行単位**でやるとシンプル。

### 💡 いつNDJSON、いつ配列JSON？
- **NDJSONが向く**：ログ、イベント、ツイート群、コーパス、RAGインデックス、逐次処理・追記・並列化したいとき。
- **配列JSONが向く**：設定ファイル、**小〜中規模**のデータ塊を**一体で共有**したいとき、厳密なネストを保ちたいとき。


## 📊 操作フェーズチェック
- **該当した番号**：① 入力の据え方（整形）  
- **コメント**：JS ラッパ→ JSON → NDJSON と**入力整形**に集中。

## 🔁 洞察と考察
- **今日の気づき・学び**：—  
- **現実との接続**：**あるかどうかも分からない過去の記録も、呼べば出てくる。良い時代だ。**  
- **見せ方／見られ方**：**扱いやすい形**とは何か？あるシステムが読み込める形ということか。  
- **問い直し**：**ちゃんと扱えるか？**（定義と処理系の両面で詰める）

## 🪶 雑記・気づき
- **今日の気分**：疲れていても、願うことはできる。**頭に浮かぶ願いや気分を書けばそれがプログラムになる**のが理想。  
- **よく浮かぶ言葉／映像**：**思考を早く機械で置き換えなくてはいけない。**

## 🙏 感謝・引用
- 関わった人／道具／資料：—  
- 「ありがとう」と言いたいこと：**ChatGPT の出力したコードも過去の誰かのツール。** その開発に感謝。

## 🛠 次の挑戦メモ
- **スレッド再構成**ユーティリティ：`reply_to_status_id` を辿って 1 スレッド = 1 ドキュメントへ。
- **フィルタ設計**：`lang=="ja"` / 期間別に**別インデックス**。RT/引用の扱いを明示。
- **差分取り込み**：`id` キーで **upsert**（重複排除）。
- **公開/非公開**の線引きルールを先に決める（参照制御）。
- **Ollama + Chroma** で最小インジェストの雛形を用意。

## 🏷 タグ
#RAG #TwitterArchive #NDJSON #データ整形 #可視化 #自動化
