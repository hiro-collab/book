## ⚙️ Day21 記録

### 1. .envファイルとDify連携の改善

（※ここに前半で話していた.env整理・Dify設定改善の内容をそのまま挿入）

---

### 2. 実装力・展開力の効率化ツール導入

めっちゃわかる。手間かけずに実装→展開を量産できる土台、作っとこ。  
Windows 11前提で、今日から回せる最短セット置いとくで。

#### 1) 開発まわりを速くする“標準装備”

- **uv（超高速パッケージ管理）**  
  ```bash
  pipx install uv
  uv venv && uv pip install -e .[dev]
  ```
  → 仮想環境作成も依存解決も爆速。Poetryより軽い運用でいける。

- **pre-commit + ruff + black**  
  → 保存前に自動整形＆Lint。レビュー負荷ゼロに寄せる。

- **テンプレリポ（雛形）**  
  最初から以下を入れた「雛形」を1個用意して、新案件は全部これから切る：
  ```
  /app
    ├─ src/（ライブラリ/GUI/CLI）
    ├─ api/（FastAPI）
    ├─ tools/（スクリプト）
    ├─ pyproject.toml
    ├─ .pre-commit-config.yaml
    ├─ .github/workflows/release.yml
    ├─ Dockerfile
    ├─ tasks.ps1   # PowerShellタスクランナー
    └─ README.md（使い方の型）
  ```

#### 2) “1コマンド”で回るタスクランナー（PowerShell）

`tasks.ps1` を置いとけば、コマンド暗記ゼロで回せる。

```powershell
# tasks.ps1
param([string]$Task="help")

function run { uv run uvicorn app.main:app --reload }
function test { uv run pytest -q }
function fmt  { uv run ruff check --fix; uv run black . }
function build-docker { docker build -t my/env-editor:latest . }
function exe { uv run pyinstaller --onefile tools/entry.py -n env-editor }
function release { git tag v$env:VER; git push origin --tags }

switch ($Task) {
  "help" { "tasks: run | test | fmt | build-docker | exe | release" }
  default { & $Task }
}
```
使い方：  
```bash
pwsh -File .\tasks.ps1 run
```

#### 3) 配布の“二刀流”

- **Docker配布**：環境差を殺して配る  
  マルチステージDockerfile（サイズ最適化）  
  ```bash
  docker run -p 8765:8765 my/env-editor
  ```

- **単体EXE配布（PyInstaller）**：IT未整備のPCにも置くだけで動く  
  GitHub Releasesに置く

> どっちもGitHub Actionsで自動ビルドにしとく

#### 4) クリックで“配れる”GitHub Actions

タグ打つだけで全部ビルド＆リリース。  
`release.yml`（ざっくりの流れ）

1. Pythonセットアップ → 依存インストール → テスト  
2. PyInstallerでEXE作成 → アーティファクト添付  
3. Docker build & push（GHCRやDocker Hub）  
4. リリース作成（CHANGELOG自動生成でもOK）

→ 「コミット→`git tag v0.2.0` → Push」でEXEとDockerが同時に配布される。

#### 5) GUI/CLIの両立（最小実装で横展開）

- FastAPI + Jinja2（GUI面）
- TyperでCLIも追加（例：`envedit import/export/check`）  
  → `--help`からREADME断片を生成して流用可

#### 6) “他の人がすぐ使える”ドキュメントの型

- READMEテンプレ
  1. 30秒クイックスタート（Docker/EXE）
  2. 使い方GIF
  3. よくある質問
  4. 互換性（Windows/WSL/Apple Silicon）
- /docs（mkdocs-material）
  - How it works（設計図）
  - Schemaの書き方
  - 拡張ポイント

#### 7) Dify/.env系の“量産に効く”決めワザ

- `env.schema.json` で必須・型・説明をJSON化  
- os.getenvスキャンON/OFFで省力化  
- エクスポート（MD/CSV）で引き継ぎ楽に

#### 8) 「DifyやとAI組みやすい」を即戦力に

- `.env`→`compose.env` 変換スクリプト
- Dev/Prodプロファイル切替GUI
- 秘密情報はOS環境 or Secret Manager優先

---

**すぐ手に入る“効率”まとめ**

1. 雛形リポ（`tasks.ps1` / Actions / Dockerfile / pre-commit）を1つ作る  
2. 新規は全部そこから切る → 常に1コマンド運用  
3. 配布はタグを打つだけでEXEとDockerが出る  
4. README/Docsも型から自動で8割埋まる

---

### 3. 次やりたいこと

- 実装と展開をセットにした「即席PoC製造キット」化
- 同一構造の雛形からDify連携・.env設計・配布まで1時間以内に回せる流れを確立
- Docker/EXE両対応の自動化率をさらに高め、外部配布でも事故らないセーフガード追加
- 小規模でも横展開できる実装テンプレの拡充（API・GUI・CLI一体型）
